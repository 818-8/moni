"use strict";(()=>{var e={};e.id=737,e.ids=[737],e.modules={145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},5613:e=>{e.exports=import("@google/genai")},6249:(e,t)=>{Object.defineProperty(t,"l",{enumerable:!0,get:function(){return function e(t,r){return r in t?t[r]:"then"in t&&"function"==typeof t.then?t.then(t=>e(t,r)):"function"==typeof t&&"default"===r?t:void 0}}})},4980:(e,t,r)=>{r.a(e,async(e,n)=>{try{r.r(t),r.d(t,{config:()=>m,default:()=>c,routeModule:()=>u});var o=r(1802),s=r(7153),a=r(6249),i=r(4321),l=e([i]);i=(l.then?(await l)():l)[0];let c=(0,a.l)(i,"default"),m=(0,a.l)(i,"config"),u=new o.PagesAPIRouteModule({definition:{kind:s.x.PAGES_API,page:"/api/gemini/analyze",pathname:"/api/gemini/analyze",bundlePath:"",filename:""},userland:i});n()}catch(e){n(e)}})},4321:(e,t,r)=>{r.a(e,async(e,n)=>{try{r.r(t),r.d(t,{default:()=>a});var o=r(5613),s=e([o]);o=(s.then?(await s)():s)[0];let i=process.env.GEMINI_API_KEY;i||console.warn("GEMINI_API_KEY not set in environment - analysis route may fail");let l=i?new o.GoogleGenAI({apiKey:i}):null;async function a(e,t){if("POST"!==e.method)return t.setHeader("Allow","POST"),t.status(405).json({error:"Method Not Allowed"});try{let r;let{scenarioTitle:n,messages:o}=e.body;if(!n||!o)return t.status(400).json({error:"Missing scenarioTitle or messages"});if(!i||!l)return t.status(500).json({error:"Server configuration error: GEMINI_API_KEY not set or invalid"});let s=o.map(e=>`${"user"===e.sender?"用户":"AI"}: ${e.text}`).join("\n"),a=`Analyze the following role-play conversation based on the scenario: "${n}".
The user is "用户" and the role-play partner is "AI".

Transcript:
${s}

Please return a JSON object with the following structure:
{
  "score": number, // 1-100分的评分
  "summary": string, // 简要总结
  "strengths": string[], // 用户表现的优点
  "improvements": string[], // 需要改进的地方
  "toneAnalysis": string // 语言和语气分析
}`,c=new AbortController,m=setTimeout(()=>c.abort(),3e4);try{r=await l.models.generateContent({model:"gemini-2.5-flash",contents:[{role:"user",parts:[{text:a}]}],config:{responseMimeType:"application/json",temperature:.9},signal:c.signal}),clearTimeout(m)}catch(e){clearTimeout(m),console.warn("Primary model failed, trying fallback...",e);try{let e=new AbortController,t=setTimeout(()=>e.abort(),3e4);r=await l.models.generateContent({model:"gemini-1.5-flash",contents:[{role:"user",parts:[{text:a}]}],config:{responseMimeType:"application/json",temperature:.9},signal:e.signal}),clearTimeout(t)}catch(e){throw clearTimeout(m),e}}let u="{}";if(r&&r.response){let e=r.response;if(e.candidates&&e.candidates.length>0){let t=e.candidates[0];if(t.content&&t.content.parts&&t.content.parts.length>0){let e=t.content.parts[0];e.text&&(u=e.text)}}}"{}"===u&&r&&r.text&&(u=r.text);let p={};try{p=JSON.parse(u),p={score:"number"==typeof p.score?p.score:0,summary:p.summary||"解析结果为空",strengths:Array.isArray(p.strengths)?p.strengths:[],improvements:Array.isArray(p.improvements)?p.improvements:[],toneAnalysis:p.toneAnalysis||"未知"}}catch(e){console.error("Failed to parse JSON response:",e),console.error("Raw response text:",u),p={score:50,summary:"分析服务返回格式异常，已使用备用分析结果",strengths:["您积极参与了对话","您尝试了不同的表达方式"],improvements:["可以尝试更清晰地表达您的想法","注意对话的连贯性和逻辑性"],toneAnalysis:"服务返回格式异常，无法提供详细分析"}}return t.status(200).json(p)}catch(o){console.error("API /api/gemini/analyze error:",o);let e={type:o instanceof Error?o.name:"Unknown Error",message:o instanceof Error?o.message:String(o),stack:void 0};console.error("Detailed error information:",JSON.stringify(e,null,2));let r="Internal Server Error",n=String(o);return o instanceof Error&&(o.message.includes("fetch failed")?(r="Network error connecting to Gemini API",n="可能是网络连接问题或Gemini API服务不可用"):o.message.includes("API key")&&(r="Invalid API key configuration",n="Gemini API密钥可能无效或已过期")),t.status(500).json({error:r,details:n,timestamp:new Date().toISOString(),fallbackAnalysis:{score:5,summary:"分析服务暂时不可用，但我们仍可以提供一些基础建议。",strengths:["您积极参与了对话","您尝试了不同的表达方式"],improvements:["可以尝试更清晰地表达您的想法","注意对话的连贯性和逻辑性"],toneAnalysis:"服务不可用，无法提供详细分析"}})}}n()}catch(e){n(e)}})},7153:(e,t)=>{var r;Object.defineProperty(t,"x",{enumerable:!0,get:function(){return r}}),function(e){e.PAGES="PAGES",e.PAGES_API="PAGES_API",e.APP_PAGE="APP_PAGE",e.APP_ROUTE="APP_ROUTE"}(r||(r={}))},1802:(e,t,r)=>{e.exports=r(145)}};var t=require("../../../webpack-api-runtime.js");t.C(e);var r=t(t.s=4980);module.exports=r})();