"use strict";(()=>{var e={};e.id=199,e.ids=[199],e.modules={145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},5613:e=>{e.exports=import("@google/genai")},6249:(e,t)=>{Object.defineProperty(t,"l",{enumerable:!0,get:function(){return function e(t,n){return n in t?t[n]:"then"in t&&"function"==typeof t.then?t.then(t=>e(t,n)):"function"==typeof t&&"default"===n?t:void 0}}})},7005:(e,t,n)=>{n.a(e,async(e,r)=>{try{n.r(t),n.d(t,{config:()=>c,default:()=>u,routeModule:()=>m});var a=n(1802),o=n(7153),s=n(6249),i=n(9383),l=e([i]);i=(l.then?(await l)():l)[0];let u=(0,s.l)(i,"default"),c=(0,s.l)(i,"config"),m=new a.PagesAPIRouteModule({definition:{kind:o.x.PAGES_API,page:"/api/gemini/chat",pathname:"/api/gemini/chat",bundlePath:"",filename:""},userland:i});r()}catch(e){r(e)}})},9383:(e,t,n)=>{n.a(e,async(e,r)=>{try{n.r(t),n.d(t,{default:()=>s});var a=n(5613),o=e([a]);a=(o.then?(await o)():o)[0];let i=process.env.GEMINI_API_KEY;i||console.warn("GEMINI_API_KEY not set in environment - API routes will fail without it");let l=i?new a.GoogleGenAI({apiKey:i}):null;async function s(e,t){if(console.log("GEMINI_API_KEY present:",!!process.env.GEMINI_API_KEY),"POST"!==e.method)return t.setHeader("Allow","POST"),t.status(405).json({error:"Method Not Allowed"});try{let n;let{messages:r,systemInstruction:a}=e.body;if(!r||!Array.isArray(r))return t.status(400).json({error:"Missing messages array in request body"});if(!i||!l)return t.status(500).json({error:"Server configuration error: GEMINI_API_KEY not set or invalid"});let o=r.map(e=>`${"user"===e.sender?"用户":"AI"}: ${e.text}`).join("\n"),s=`${a||""}

Transcript:
${o}

Respond as the role-play partner in a natural conversational way.`,u=new AbortController,c=setTimeout(()=>u.abort(),3e4);try{n=await l.models.generateContent({model:"gemini-2.5-flash",contents:[{role:"user",parts:[{text:s}]}],config:{temperature:.9},signal:u.signal}),clearTimeout(c)}catch(e){clearTimeout(c),console.warn("Primary model failed, trying fallback...",e);try{let e=new AbortController,t=setTimeout(()=>e.abort(),3e4);n=await l.models.generateContent({model:"gemini-1.5-flash",contents:[{role:"user",parts:[{text:s}]}],config:{temperature:.9},signal:e.signal}),clearTimeout(t)}catch(e){throw clearTimeout(c),e}}let m="";if(n&&n.response){let e=n.response;if(e.candidates&&e.candidates.length>0){let t=e.candidates[0];if(t.content&&t.content.parts&&t.content.parts.length>0){let e=t.content.parts[0];e.text&&(m=e.text)}}}return!m&&n&&n.text&&(m=n.text),m=m||"（对方未回应）",t.status(200).json({text:m})}catch(n){console.error("API /api/gemini/chat error:",n);let e={type:n instanceof Error?n.name:"Unknown Error",message:n instanceof Error?n.message:String(n),stack:void 0};if(console.error("Detailed error information:",JSON.stringify(e,null,2)),"AbortError"===n.name)return t.status(504).json({error:"网络连接超时：无法连接到Gemini服务。",details:"请求处理时间超过了30秒的超时限制。\n\n可能的解决方案：\n1. 检查防火墙设置，确保允许连接到Google API\n2. 如果使用VPN，请尝试暂时断开\n3. 检查网络代理设置\n4. 稍后再试，服务可能暂时不可用",timestamp:new Date().toISOString()});if(n.message.includes("403")||n.message.includes("unauthorized"))return t.status(401).json({error:"API密钥无效或权限不足",details:"提供的Gemini API密钥无效或者没有足够的权限访问指定的资源。",timestamp:new Date().toISOString()});if(n.message.includes("429"))return t.status(429).json({error:"请求频率过高，请稍后再试",details:"您已达到API请求限制。请减少请求频率或稍后再试。",timestamp:new Date().toISOString()});if(n.message.includes("ENOTFOUND")||n.message.includes("ECONNREFUSED"))return t.status(503).json({error:"网络连接失败：无法连接到Gemini服务。",details:"\n\n可能的解决方案：\n1. 检查防火墙设置，确保允许连接到Google API\n2. 如果使用VPN，请尝试暂时断开\n3. 检查网络代理设置\n4. 稍后再试，服务可能暂时不可用",timestamp:new Date().toISOString()});if(n.message.includes("API key"))return t.status(500).json({error:"服务器配置错误：API密钥无效",details:"服务器无法使用提供的API密钥。请检查环境变量配置。",timestamp:new Date().toISOString()});if(n instanceof Error&&n.message.includes("fetch failed"))return t.status(500).json({error:"网络错误连接到Gemini API",details:"可能是网络连接问题或Gemini API服务不可用。请检查网络连接并重试。",timestamp:new Date().toISOString()});return t.status(500).json({error:"服务器处理请求时出错",details:n instanceof Error?n.message:String(n),timestamp:new Date().toISOString()})}}r()}catch(e){r(e)}})},7153:(e,t)=>{var n;Object.defineProperty(t,"x",{enumerable:!0,get:function(){return n}}),function(e){e.PAGES="PAGES",e.PAGES_API="PAGES_API",e.APP_PAGE="APP_PAGE",e.APP_ROUTE="APP_ROUTE"}(n||(n={}))},1802:(e,t,n)=>{e.exports=n(145)}};var t=require("../../../webpack-api-runtime.js");t.C(e);var n=t(t.s=7005);module.exports=n})();