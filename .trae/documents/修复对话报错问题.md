## 修复对话报错问题

### 问题分析

通过代码分析，我发现了几个导致对话报错的问题：

1. **前后端消息格式不匹配**：
   - `gemini.ts` 中的 `sendMessageToAI` 函数返回的是 `{ content, role, timestamp }` 格式
   - 而 `chat.ts` API 路由返回的是 `{ text: responseText }` 格式
   - 前端组件期望的是完整的 `Message` 对象格式

2. **API 路由中的发送者识别问题**：
   - API 路由中假设 `sender` 是字符串 'user'，但实际 `Sender` 枚举中 AI 是 'model'
   - 构建转录文本时可能导致识别错误

3. **API 响应处理问题**：
   - 安全获取文本响应的代码路径可能不正确
   - 没有正确处理 `@google/genai` 库的响应格式

### 修复方案

1. **修改 `gemini.ts` 中的 `sendMessageToAI` 函数**：
   - 确保正确处理 API 返回的 `{ text }` 格式
   - 返回符合前端期望的消息格式

2. **修改 `chat.ts` API 路由**：
   - 修复发送者识别逻辑，正确处理 `Sender` 枚举
   - 优化 API 响应处理，确保正确获取文本内容
   - 添加更详细的错误日志

3. **验证前后端消息格式一致性**：
   - 确保所有消息传递都使用统一的格式
   - 添加类型检查以防止格式错误

### 修复步骤

1. 修复 `gemini.ts` 中的 `sendMessageToAI` 函数
2. 修复 `chat.ts` 中的发送者识别和响应处理
3. 测试修复后的对话功能
4. 确保所有错误情况都能被正确处理

### 预期效果

- 对话功能能够正常工作
- 前后端消息格式一致
- 错误信息能够被正确捕获和显示
- 提高系统的稳定性和可靠性