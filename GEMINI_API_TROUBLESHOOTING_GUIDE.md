# Gemini API 连接问题故障排除指南

## 1. 问题概述

本文档提供了解决Gemini API连接问题的详细步骤和解决方案。根据我们的网络诊断工具检测结果，主要问题可能是：

- **防火墙限制**：网络环境中的防火墙可能阻止了与Google API服务器的连接
- **证书验证错误**：系统证书问题导致HTTPS连接失败
- **网络配置限制**：企业网络或安全软件的限制

## 2. 诊断步骤

### 2.1 运行网络诊断工具

我们提供了一个专用的网络诊断工具，可以帮助识别具体问题：

```bash
# 运行网络诊断工具
node network-diagnostic.js
```

### 2.2 检查网络连接状态

诊断工具会测试以下项目：

- HTTP/HTTPS基本连接
- DNS解析功能
- 端口连通性（特别是443端口）
- 证书验证状态
- 系统网络配置

### 2.3 分析诊断结果

根据诊断结果，主要关注以下指标：

- **Gemini API端口测试**：如果显示"连接超时"，表示网络连接被阻止
- **DNS解析**：确保能够正确解析 `generativelanguage.googleapis.com`
- **证书验证**：检查是否存在证书相关错误

## 3. 解决方案

### 3.1 防火墙和网络限制解决方案

1. **检查防火墙设置**：
   - 临时关闭防火墙测试连接
   - 允许应用程序通过防火墙访问网络
   - 特别允许连接到Google API相关域名和IP地址

2. **VPN和代理设置**：
   - 如果使用VPN，尝试暂时断开
   - 检查并配置正确的代理设置：
     ```bash
     # 设置代理环境变量（如适用）
     set HTTPS_PROXY=http://your-proxy-server:port
     ```

3. **企业网络解决方案**：
   - 联系IT部门，请求解除对Google API的访问限制
   - 使用企业批准的网络路径访问服务

### 3.2 证书验证问题解决

1. **证书配置**：
   - 确保系统日期和时间正确
   - 更新系统证书库
   - 对于开发环境，可以在代码中临时禁用证书验证（仅用于测试）

2. **Node.js证书问题**：
   - 使用系统证书运行Node.js：
     ```bash
     node --use-system-ca-certs your-script.js
     ```

### 3.3 使用离线模式

当无法解决网络连接问题时，可以使用应用程序的离线模式：

1. **启用离线模式**：
   - 在代码中调用：
     ```javascript
     import { setOfflineMode } from './services/gemini';
     
     // 启用离线模式
     setOfflineMode(true);
     ```

2. **离线模式功能**：
   - 提供模拟的AI回复
   - 保持应用程序基本功能可用
   - 在响应中明确标识为离线模式回复

3. **离线模式限制**：
   - 仅提供预定义的模拟回复
   - 不支持复杂的AI生成内容
   - 分析功能基于模拟数据

## 4. 配置和设置

### 4.1 API密钥配置

确保正确配置了Gemini API密钥：

1. **检查.env.local文件**：
   ```env
   GEMINI_API_KEY=AIzaSyCLEEsl_W6JdSpBY3_esi2tBXkAlrxoXWs
   ```

2. **验证密钥有效性**：
   - 确认密钥未过期
   - 检查是否有使用限制或配额问题

### 4.2 离线模式配置

自定义离线模式设置：

- **延迟调整**：修改`config.offlineDelay`值调整模拟延迟
- **模拟响应自定义**：编辑`mockResponses`对象添加更多模拟场景
- **默认模式设置**：根据需要修改`config.offlineMode`的默认值

## 5. 最佳实践

### 5.1 开发环境建议

- 在开发时使用离线模式进行功能测试
- 定期运行网络诊断工具检查连接状态
- 记录网络环境变化对连接的影响

### 5.2 生产环境建议

- 实施全面的错误处理和重试机制
- 设置监控系统跟踪API连接状态
- 准备备用方案，如使用其他AI服务或缓存响应

### 5.3 网络环境优化

- 使用稳定的网络连接
- 配置可靠的DNS服务器（如8.8.8.8或1.1.1.1）
- 避免使用可能限制API访问的公共网络

## 6. 其他资源

- [Google AI Studio文档](https://ai.google.dev/studio)
- [Google API客户端库](https://github.com/googleapis/google-api-nodejs-client)
- [Node.js HTTPS文档](https://nodejs.org/api/https.html)

## 7. 联系支持

如果尝试了上述所有解决方案仍无法解决问题：

- 检查Google Cloud状态页面，确认Gemini服务是否正常运行
- 联系Google Cloud支持获取专业帮助
- 考虑使用其他AI服务作为替代方案

---

**更新日期**：2024年
**版本**：1.0

*本指南由网络诊断团队创建，用于帮助解决Gemini API连接问题。*